<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù…Ø¹Ø¯Ù„ Ø·Ø§Ù„Ø¨ Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø¹Ù„ÙŠØ§</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/docx@7.7.0/build/index.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: linear-gradient(135deg, #dde3ff 0%, #eef0ff 40%, #e8f0fe 70%, #d8e9ff 100%);
      --surface: #ffffff;
      --surface2: #f4f5ff;
      --border: rgba(91,82,232,0.15);
      --accent: #5b52e8;
      --accent-light: #ede9ff;
      --accent2: #e8445a;
      --accent3: #0fba6e;
      --warn: #f59e0b;
      --text: #1e1b4b;
      --text-dim: #6b7280;
      --radius: 14px;
      --shadow: 0 2px 20px rgba(91,82,232,0.10);
    }

    body {
      font-family: 'Tajawal', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 30px 16px 60px;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(ellipse 70% 50% at 10% 0%, rgba(91,82,232,0.18) 0%, transparent 55%),
        radial-gradient(ellipse 50% 40% at 90% 100%, rgba(59,130,246,0.12) 0%, transparent 55%);
      pointer-events: none;
      z-index: 0;
    }

    .page { position: relative; z-index: 1; max-width: 720px; margin: 0 auto; }

    /* â”€â”€ Header â”€â”€ */
    .page-header {
      text-align: center;
      margin-bottom: 32px;
    }
    .header-icon {
      display: inline-flex; align-items: center; justify-content: center;
      width: 60px; height: 60px;
      background: linear-gradient(135deg, #5b52e8, #818cf8);
      border-radius: 16px;
      font-size: 26px; margin-bottom: 12px;
      box-shadow: 0 8px 24px rgba(91,82,232,0.35);
    }
    h1 { font-size: clamp(20px,4vw,28px); font-weight: 800; color: var(--text); }
    h1 span { color: var(--accent); }
    .page-subtitle { color: var(--text-dim); font-size: 14px; margin-top: 6px; }

    /* â”€â”€ Progress Steps â”€â”€ */
    .steps {
      display: flex; align-items: center; justify-content: center;
      gap: 0; margin-bottom: 28px; flex-wrap: nowrap; overflow-x: auto;
    }
    .step {
      display: flex; flex-direction: column; align-items: center; gap: 4px;
      flex: 1; min-width: 60px; position: relative;
    }
    .step:not(:last-child)::after {
      content: '';
      position: absolute; top: 16px; left: 0;
      width: 100%; height: 2px;
      background: var(--border);
      z-index: 0;
    }
    .step.done:not(:last-child)::after { background: var(--accent); }
    .step-dot {
      width: 32px; height: 32px; border-radius: 50%;
      border: 2px solid var(--border);
      background: var(--surface);
      display: flex; align-items: center; justify-content: center;
      font-size: 13px; font-weight: 700; color: var(--text-dim);
      position: relative; z-index: 1;
      transition: all 0.3s;
    }
    .step.active .step-dot {
      border-color: var(--accent); background: var(--accent); color: #fff;
      box-shadow: 0 0 0 4px rgba(91,82,232,0.15);
    }
    .step.done .step-dot {
      border-color: var(--accent3); background: var(--accent3); color: #fff;
    }
    .step-label { font-size: 10px; color: var(--text-dim); text-align: center; white-space: nowrap; }
    .step.active .step-label { color: var(--accent); font-weight: 700; }
    .step.done .step-label { color: var(--accent3); }

    /* â”€â”€ Card â”€â”€ */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      margin-bottom: 16px;
      box-shadow: var(--shadow);
    }
    .card-title {
      font-size: 12px; font-weight: 700;
      text-transform: uppercase; letter-spacing: 1.2px;
      color: var(--accent); margin-bottom: 18px;
      padding-bottom: 10px; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; gap: 8px;
    }

    /* â”€â”€ Form Elements â”€â”€ */
    .field { margin-bottom: 16px; }
    .field:last-child { margin-bottom: 0; }
    label.field-label {
      display: block; font-size: 12px; font-weight: 700;
      color: var(--text-dim); text-transform: uppercase;
      letter-spacing: 0.8px; margin-bottom: 7px;
    }
    input[type="text"], input[type="number"], select {
      width: 100%; padding: 12px 14px;
      background: var(--surface2);
      border: 1.5px solid var(--border);
      border-radius: 10px;
      color: var(--text); font-size: 15px;
      font-family: 'Tajawal', sans-serif;
      transition: border-color 0.2s, box-shadow 0.2s;
      appearance: none; -webkit-appearance: none;
    }
    input:focus, select:focus {
      outline: none; border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(91,82,232,0.12);
    }
    select option { background: #fff; }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 480px) { .grid-2 { grid-template-columns: 1fr; } }

    /* â”€â”€ Buttons â”€â”€ */
    .btn {
      display: inline-flex; align-items: center; justify-content: center;
      gap: 8px; padding: 12px 20px;
      border: none; border-radius: 10px;
      font-size: 15px; font-weight: 700;
      font-family: 'Tajawal', sans-serif;
      cursor: pointer; transition: all 0.2s;
    }
    .btn-primary {
      background: linear-gradient(135deg, #5b52e8, #818cf8);
      color: #fff; width: 100%;
      box-shadow: 0 4px 16px rgba(91,82,232,0.3);
    }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(91,82,232,0.4); }
    .btn-primary:active { transform: translateY(0); }

    .btn-success { background: var(--accent3); color: #fff; }
    .btn-success:hover { background: #0da862; }
    .btn-danger  { background: var(--accent2); color: #fff; }
    .btn-danger:hover  { background: #d63a50; }
    .btn-info    { background: #0ea5e9; color: #fff; }
    .btn-info:hover    { background: #0284c7; }
    .btn-warn    { background: var(--warn); color: #fff; }
    .btn-outline {
      background: transparent;
      border: 1.5px solid var(--border);
      color: var(--text-dim);
    }
    .btn-outline:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-light); }
    .btn-sm { padding: 7px 12px; font-size: 13px; border-radius: 8px; }
    .btn-full { width: 100%; }
    .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
    .btn-group .btn { flex: 1; min-width: 120px; }

    /* â”€â”€ Yes/No choice â”€â”€ */
    .choice-group { display: flex; gap: 12px; }
    .choice-btn {
      flex: 1; padding: 14px;
      border: 2px solid var(--border);
      border-radius: 12px;
      background: var(--surface2);
      color: var(--text-dim);
      font-size: 15px; font-weight: 700;
      font-family: 'Tajawal', sans-serif;
      cursor: pointer; transition: all 0.2s;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .choice-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-light); }
    .choice-btn.yes:hover { border-color: var(--accent3); color: var(--accent3); background: #e6faf2; }
    .choice-btn.no:hover  { border-color: var(--accent2); color: var(--accent2); background: #fde8eb; }

    /* â”€â”€ Section block â”€â”€ */
    .section-block {
      border: 1.5px solid var(--border);
      border-radius: 12px; padding: 18px;
      background: var(--surface2);
      margin-bottom: 14px;
    }
    .section-block-title {
      font-size: 13px; font-weight: 700;
      color: var(--accent); margin-bottom: 14px;
      display: flex; align-items: center; gap: 6px;
    }

    /* â”€â”€ Subjects Table â”€â”€ */
    .subjects-table { width: 100%; border-collapse: collapse; font-size: 14px; }
    .subjects-table thead th {
      background: var(--accent); color: #fff;
      padding: 10px 12px; text-align: center;
      font-weight: 700; font-size: 13px;
    }
    .subjects-table thead th:first-child { border-radius: 8px 0 0 0; }
    .subjects-table thead th:last-child  { border-radius: 0 8px 0 0; }
    .subjects-table tbody tr { border-bottom: 1px solid var(--border); }
    .subjects-table tbody tr:hover { background: var(--accent-light); }
    .subjects-table td { padding: 6px 6px; text-align: center; }
    .subjects-table td input {
      padding: 8px 10px; font-size: 14px;
      background: var(--surface); border-radius: 7px;
    }
    .subjects-table td:first-child { width: 40%; }
    .subjects-table td:first-child input { text-align: right; }

    /* â”€â”€ Result box â”€â”€ */
    .result-box {
      border-radius: 12px; padding: 16px 20px;
      margin-top: 4px;
      display: flex; align-items: center; gap: 14px;
    }
    .result-box.success { background: #e6faf2; border: 1.5px solid #0fba6e; }
    .result-box.final   { background: linear-gradient(135deg, #ede9ff, #e0e7ff); border: 1.5px solid var(--accent); }
    .result-icon { font-size: 28px; flex-shrink: 0; }
    .result-label { font-size: 13px; color: var(--text-dim); }
    .result-value { font-size: 26px; font-weight: 800; color: var(--accent); line-height: 1; }
    .result-box.success .result-value { color: var(--accent3); }
    .result-sub { font-size: 12px; color: var(--text-dim); margin-top: 3px; }

    /* â”€â”€ Records Table â”€â”€ */
    .records-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .records-table thead th {
      background: var(--accent); color: #fff;
      padding: 10px 8px; text-align: center; font-weight: 700;
    }
    .records-table tbody tr { border-bottom: 1px solid var(--border); transition: background 0.15s; }
    .records-table tbody tr:hover { background: var(--accent-light); }
    .records-table td { padding: 10px 8px; text-align: center; font-size: 13px; }
    .records-table td:nth-child(3) { text-align: right; }
    .table-wrap { overflow-x: auto; border-radius: 10px; border: 1px solid var(--border); }
    .records-empty { text-align: center; color: var(--text-dim); padding: 32px; font-size: 14px; }

    /* â”€â”€ Badge â”€â”€ */
    .badge {
      display: inline-block; padding: 3px 10px;
      border-radius: 20px; font-size: 12px; font-weight: 700;
    }
    .badge-phd     { background: #ede9ff; color: #5b52e8; }
    .badge-master  { background: #e0f2fe; color: #0369a1; }
    .badge-diploma { background: #fef3c7; color: #92400e; }

    /* â”€â”€ Toast â”€â”€ */
    #toast {
      position: fixed; bottom: 24px; left: 50%;
      transform: translateX(-50%) translateY(80px);
      padding: 12px 24px; border-radius: 10px;
      font-size: 14px; font-weight: 700;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      z-index: 9999; opacity: 0; white-space: nowrap;
      transition: transform 0.3s cubic-bezier(.34,1.56,.64,1), opacity 0.3s;
      background: #fff; border: 1.5px solid var(--border); color: var(--text);
    }
    #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    #toast.success { background: #e6faf2; border-color: var(--accent3); color: #0a7a48; }
    #toast.error   { background: #fde8eb; border-color: var(--accent2); color: #b01c30; }
    #toast.info    { background: var(--accent-light); border-color: var(--accent); color: var(--accent); }

    footer { text-align: center; color: var(--text-dim); font-size: 12px; margin-top: 40px; }
    footer span { color: var(--accent); font-weight: 700; }

    /* Hidden */
    .hidden { display: none !important; }

    /* Number input counter */
    .count-row { display: flex; gap: 10px; align-items: flex-end; }
    .count-row .field { flex: 1; margin-bottom: 0; }
    .count-row .btn { flex-shrink: 0; padding: 12px 18px; }
    /* â”€â”€ Edit Modal â”€â”€ */
    .modal-overlay {
      position: fixed; inset: 0; z-index: 1000;
      background: rgba(30,27,75,0.45);
      backdrop-filter: blur(4px);
      display: flex; align-items: center; justify-content: center;
      padding: 16px;
      opacity: 0; pointer-events: none;
      transition: opacity 0.25s;
    }
    .modal-overlay.open { opacity: 1; pointer-events: all; }
    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 28px;
      width: 100%; max-width: 500px;
      box-shadow: 0 24px 60px rgba(91,82,232,0.25);
      transform: translateY(20px);
      transition: transform 0.25s;
      max-height: 90vh; overflow-y: auto;
    }
    .modal-overlay.open .modal { transform: translateY(0); }
    .modal-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 20px; padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }
    .modal-title { font-size: 16px; font-weight: 800; color: var(--accent); }
    .modal-close {
      width: 32px; height: 32px; border-radius: 8px;
      border: 1px solid var(--border); background: var(--surface2);
      cursor: pointer; font-size: 16px; color: var(--text-dim);
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s;
    }
    .modal-close:hover { border-color: var(--accent2); color: var(--accent2); }
    .modal-info-row {
      display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 18px;
    }
    .modal-chip {
      background: var(--accent-light); color: var(--accent);
      border-radius: 20px; padding: 4px 12px;
      font-size: 12px; font-weight: 700;
    }
    .edit-subjects-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-bottom: 16px; }
    .edit-subjects-table thead th {
      background: var(--accent); color: #fff;
      padding: 8px 10px; text-align: center; font-size: 12px;
    }
    .edit-subjects-table tbody tr { border-bottom: 1px solid var(--border); }
    .edit-subjects-table td { padding: 5px 5px; text-align: center; }
    .edit-subjects-table td:first-child { text-align: right; font-size: 13px; color: var(--text); padding-right: 10px; }
    .edit-subjects-table td input {
      padding: 7px 8px; font-size: 13px; width: 100%;
      background: var(--surface2); border: 1.5px solid var(--border);
      border-radius: 7px; color: var(--text);
      font-family: 'Tajawal', sans-serif;
    }
    .edit-subjects-table td input:focus {
      outline: none; border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(91,82,232,0.1);
    }
    .section-divider {
      font-size: 11px; font-weight: 700; color: var(--accent);
      text-transform: uppercase; letter-spacing: 1px;
      padding: 8px 0 6px; border-top: 1px solid var(--border);
      margin-top: 4px;
    }
  </style>
</head>
<body>

<div class="page">

  <!-- Header -->
  <div class="page-header">
    <div class="header-icon">ğŸ“</div>
    <h1>Ù…Ø¹Ø¯Ù„ Ø·Ø§Ù„Ø¨ <span>Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø¹Ù„ÙŠØ§</span></h1>
    <p class="page-subtitle">Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø¨Ø¯Ù‚Ø© Ù„Ù„Ø¯ÙƒØªÙˆØ±Ø§Ù‡ ÙˆØ§Ù„Ù…Ø§Ø¬Ø³ØªÙŠØ± ÙˆØ§Ù„Ø¯Ø¨Ù„ÙˆÙ…</p>
  </div>

  <!-- Progress Steps -->
  <div class="steps" id="stepsBar">
    <div class="step active" id="step-1">
      <div class="step-dot">1</div>
      <div class="step-label">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
    </div>
    <div class="step" id="step-2">
      <div class="step-dot">2</div>
      <div class="step-label">Ø§Ù„ÙƒÙˆØ±Ø³ Ø§Ù„Ø£ÙˆÙ„</div>
    </div>
    <div class="step" id="step-3">
      <div class="step-dot">3</div>
      <div class="step-label">Ø§Ù„ÙƒÙˆØ±Ø³ Ø§Ù„Ø«Ø§Ù†ÙŠ</div>
    </div>
    <div class="step" id="step-4">
      <div class="step-dot">4</div>
      <div class="step-label">Ø§Ù„Ø±Ø³Ø§Ù„Ø©</div>
    </div>
    <div class="step" id="step-5">
      <div class="step-dot"><i class="fas fa-check" style="font-size:11px;"></i></div>
      <div class="step-label">Ø§Ù„Ù†ØªÙŠØ¬Ø©</div>
    </div>
  </div>

  <!-- â•â• STEP 1: Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ â•â• -->
  <div class="card" id="cardInfo">
    <div class="card-title"><i class="fas fa-user-graduate"></i> Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</div>
    <div class="field">
      <label class="field-label">Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¹Ù„Ù…ÙŠ</label>
      <input type="text" id="department" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¹Ù„Ù…ÙŠ" />
    </div>
    <div class="field">
      <label class="field-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ</label>
      <input type="text" id="studentName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ ÙƒØ§Ù…Ù„Ø§Ù‹" />
    </div>
    <div class="field">
      <label class="field-label">Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</label>
      <select id="stage">
        <option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø© â€”</option>
        <option value="phd">Ø¯ÙƒØªÙˆØ±Ø§Ù‡</option>
        <option value="master">Ù…Ø§Ø¬Ø³ØªÙŠØ±</option>
        <option value="diploma">Ø¯Ø¨Ù„ÙˆÙ…</option>
      </select>
    </div>
    <button class="btn btn-primary" onclick="goToCourse1()">
      <i class="fas fa-arrow-left"></i> Ø§Ù„ØªØ§Ù„ÙŠ: Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙˆØ§Ø¯ Ø§Ù„ÙƒÙˆØ±Ø³ Ø§Ù„Ø£ÙˆÙ„
    </button>
  </div>

  <!-- â•â• STEP 2: Ø§Ù„ÙƒÙˆØ±Ø³ Ø§Ù„Ø£ÙˆÙ„ â•â• -->
  <div class="card hidden" id="cardCourse1">
    <div class="card-title"><i class="fas fa-book"></i> Ù…ÙˆØ§Ø¯ Ø§Ù„ÙƒÙˆØ±Ø³ Ø§Ù„Ø£ÙˆÙ„</div>
    <div class="section-block">
      <div class="count-row">
        <div class="field">
          <label class="field-label">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯</label>
          <input type="number" id="course1Count" min="1" max="20" placeholder="Ù…Ø«Ø§Ù„: 5" />
        </div>
        <button class="btn btn-outline" onclick="generateCourseTable(1)">
          <i class="fas fa-table"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        </button>
      </div>
    </div>
    <div id="course1TableDiv"></div>
    <div id="calculateCourse1Div" class="hidden" style="margin-top:14px;">
      <button class="btn btn-primary" onclick="calculateCourse1()">
        <i class="fas fa-calculator"></i> Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙƒÙˆØ±Ø³ Ø§Ù„Ø£ÙˆÙ„
      </button>
    </div>
    <div id="course1AvgDiv" class="hidden" style="margin-top:14px;">
      <div class="result-box success">
        <div class="result-icon">ğŸ“Š</div>
        <div>
          <div class="result-label">Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙƒÙˆØ±Ø³ Ø§Ù„Ø£ÙˆÙ„</div>
          <div class="result-value" id="course1AvgVal">--</div>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â• STEP 2b: Ù‡Ù„ ÙŠÙˆØ¬Ø¯ ÙƒÙˆØ±Ø³ Ø«Ø§Ù†ÙØŸ â•â• -->
  <div class="card hidden" id="cardAskCourse2">
    <div class="card-title"><i class="fas fa-question-circle"></i> Ø§Ù„ÙƒÙˆØ±Ø³ Ø§Ù„Ø«Ø§Ù†ÙŠ</div>
    <p style="font-size:15px; margin-bottom:16px; color:var(--text-dim);">Ù‡Ù„ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ ÙÙŠ Ø§Ù„ÙƒÙˆØ±Ø³ Ø§Ù„Ø«Ø§Ù†ÙŠØŸ</p>
    <div class="choice-group">
      <button class="choice-btn yes" onclick="showCourse2Input(true)">
        <i class="fas fa-check-circle"></i> Ù†Ø¹Ù…
      </button>
      <button class="choice-btn no" onclick="showCourse2Input(false)">
        <i class="fas fa-times-circle"></i> Ù„Ø§ØŒ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø±Ø³Ø§Ù„Ø©
      </button>
    </div>
  </div>

  <!-- â•â• STEP 3: Ø§Ù„ÙƒÙˆØ±Ø³ Ø§Ù„Ø«Ø§Ù†ÙŠ â•â• -->
  <div class="card hidden" id="cardCourse2">
    <div class="card-title"><i class="fas fa-book-open"></i> Ù…ÙˆØ§Ø¯ Ø§Ù„ÙƒÙˆØ±Ø³ Ø§Ù„Ø«Ø§Ù†ÙŠ</div>
    <div class="section-block">
      <div class="count-row">
        <div class="field">
          <label class="field-label">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯</label>
          <input type="number" id="course2Count" min="1" max="20" placeholder="Ù…Ø«Ø§Ù„: 5" />
        </div>
        <button class="btn btn-outline" onclick="generateCourseTable(2)">
          <i class="fas fa-table"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        </button>
      </div>
    </div>
    <div id="course2TableDiv"></div>
    <div id="calculateCourse2Div" class="hidden" style="margin-top:14px;">
      <button class="btn btn-primary" onclick="calculateCourse2()">
        <i class="fas fa-calculator"></i> Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙƒÙˆØ±Ø³ Ø§Ù„Ø«Ø§Ù†ÙŠ
      </button>
    </div>
    <div id="course2AvgDiv" class="hidden" style="margin-top:14px;">
      <div class="result-box success">
        <div class="result-icon">ğŸ“Š</div>
        <div>
          <div class="result-label">Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙƒÙˆØ±Ø³ Ø§Ù„Ø«Ø§Ù†ÙŠ</div>
          <div class="result-value" id="course2AvgVal">--</div>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â• STEP 4: Ø§Ù„Ø±Ø³Ø§Ù„Ø© â•â• -->
  <div class="card hidden" id="cardAskThesis">
    <div class="card-title"><i class="fas fa-scroll"></i> Ø§Ù„Ø±Ø³Ø§Ù„Ø© / Ø§Ù„Ø£Ø·Ø±ÙˆØ­Ø©</div>
    <p style="font-size:15px; margin-bottom:16px; color:var(--text-dim);">Ù‡Ù„ ØªÙ… ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø±Ø³Ø§Ù„Ø© / Ø§Ù„Ø£Ø·Ø±ÙˆØ­Ø©ØŸ</p>
    <div class="choice-group">
      <button class="choice-btn yes" onclick="showThesisInput(true)">
        <i class="fas fa-check-circle"></i> Ù†Ø¹Ù…
      </button>
      <button class="choice-btn no" onclick="showThesisInput(false)">
        <i class="fas fa-times-circle"></i> Ù„Ø§ØŒ Ø­Ø³Ø§Ø¨ Ø¨Ø¯ÙˆÙ† Ø±Ø³Ø§Ù„Ø©
      </button>
    </div>
  </div>

  <div class="card hidden" id="cardThesis">
    <div class="card-title"><i class="fas fa-graduation-cap"></i> Ø¯Ø±Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©</div>
    <div class="field">
      <label class="field-label">Ø§Ù„Ø¯Ø±Ø¬Ø© (0 â€“ 100)</label>
      <input type="number" id="thesisGrade" min="0" max="100" placeholder="Ø£Ø¯Ø®Ù„ Ø¯Ø±Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©" />
    </div>
    <button class="btn btn-primary" onclick="calculateFinalAvg(true)">
      <i class="fas fa-star"></i> Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
    </button>
  </div>

  <!-- â•â• STEP 5: Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© â•â• -->
  <div class="card hidden" id="cardResult">
    <div class="card-title"><i class="fas fa-trophy"></i> Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</div>
    <div id="finalResultBox"></div>
    <div style="margin-top: 16px;" id="formulaBox"></div>
    <div class="btn-group" style="margin-top:18px;">
      <button class="btn btn-success" onclick="saveResult()">
        <i class="fas fa-save"></i> Ø­ÙØ¸
      </button>
      <button class="btn btn-info" onclick="downloadDOCX()">
        <i class="fas fa-file-word"></i> ØªØ­Ù…ÙŠÙ„ Word
      </button>
      <button class="btn btn-danger" onclick="resetAll()">
        <i class="fas fa-redo"></i> Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
      </button>
    </div>
  </div>

  <!-- â•â• Ø·Ø§Ù„Ø¨ Ø¢Ø®Ø±ØŸ â•â• -->
  <div class="card hidden" id="cardNextStudent" style="border: 2px solid var(--accent3);">
    <div class="card-title" style="color: var(--accent3);"><i class="fas fa-user-plus"></i> Ø¥Ø¯Ø®Ø§Ù„ Ø·Ø§Ù„Ø¨ Ø¢Ø®Ø±</div>
    <div style="background: #e6faf2; border-radius: 10px; padding: 16px; margin-bottom: 18px; display: flex; gap: 12px; align-items: flex-start;">
      <span style="font-size: 24px;">ğŸ’¡</span>
      <div>
        <div style="font-weight: 700; font-size: 15px; color: #0a7a48;">Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¯Ø®Ø§Ù„ Ø¯Ø±Ø¬Ø§Øª Ø·Ø§Ù„Ø¨ Ø¢Ø®Ø±ØŸ</div>
        <div style="font-size: 13px; color: var(--text-dim); margin-top: 4px;">Ø³ÙŠØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø£ÙˆØ²Ø§Ù† â€” ÙÙ‚Ø· Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆØ¯Ø±Ø¬Ø§ØªÙ‡</div>
      </div>
    </div>
    <div class="choice-group">
      <button class="choice-btn yes" onclick="nextStudent()">
        <i class="fas fa-user-plus"></i> Ù†Ø¹Ù…ØŒ Ø·Ø§Ù„Ø¨ Ø¢Ø®Ø± Ø¨Ù†ÙØ³ Ø§Ù„Ù…ÙˆØ§Ø¯
      </button>
      <button class="choice-btn no" onclick="resetAll()">
        <i class="fas fa-redo"></i> Ù„Ø§ØŒ Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯
      </button>
    </div>
  </div>

  <!-- â•â• Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© â•â• -->
  <div class="card" style="margin-top: 24px;">
    <div class="card-title" style="justify-content:space-between;">
      <span><i class="fas fa-history"></i> Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</span>
      <div style="display:flex; gap:8px;">
        <button class="btn btn-info btn-sm" onclick="downloadRecordsDOCX()">
          <i class="fas fa-file-word"></i> ØªØµØ¯ÙŠØ±
        </button>
        <button class="btn btn-danger btn-sm" onclick="confirmDeleteAll()">
          <i class="fas fa-trash-alt"></i> Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„
        </button>
      </div>
    </div>
    <div id="recordsWrap">
      <div class="records-empty"><i class="fas fa-inbox" style="font-size:28px; display:block; margin-bottom:8px;"></i>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©</div>
    </div>
  </div>

  <footer>Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù†Ø´Ø± Â© <span>Ø¯. Ø·Ù„Ø§Ù„ Ù†Ø§Ø¸Ù… Ø§Ù„Ø²Ù‡ÙŠØ±ÙŠ</span> Ùˆ <span>Ø¯. Ø¹Ù„ÙŠ Ø¹Ø¨Ø¯ Ø§Ù„ØµÙ…Ø¯</span> â€” 2025</footer>
</div>

<!-- â•â• Edit Modal â•â• -->
<div class="modal-overlay" id="editModalOverlay" onclick="closeEditModal(event)">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</div>
      <button class="modal-close" onclick="closeEditModal(null)">âœ•</button>
    </div>
    <div class="modal-info-row" id="modalInfoRow"></div>

    <!-- Course 1 grades -->
    <div class="section-divider"><i class="fas fa-book"></i> Ø¯Ø±Ø¬Ø§Øª Ø§Ù„ÙƒÙˆØ±Ø³ Ø§Ù„Ø£ÙˆÙ„</div>
    <div style="overflow-x:auto; border-radius:8px; border:1px solid var(--border); margin-bottom:8px;">
      <table class="edit-subjects-table">
        <thead><tr><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø© (0-100)</th></tr></thead>
        <tbody id="editCourse1Body"></tbody>
      </table>
    </div>

    <!-- Course 2 grades (if exists) -->
    <div id="editCourse2Section" class="hidden">
      <div class="section-divider"><i class="fas fa-book-open"></i> Ø¯Ø±Ø¬Ø§Øª Ø§Ù„ÙƒÙˆØ±Ø³ Ø§Ù„Ø«Ø§Ù†ÙŠ</div>
      <div style="overflow-x:auto; border-radius:8px; border:1px solid var(--border); margin-bottom:8px;">
        <table class="edit-subjects-table">
          <thead><tr><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø© (0-100)</th></tr></thead>
          <tbody id="editCourse2Body"></tbody>
        </table>
      </div>
    </div>

    <!-- Thesis grade -->
    <div class="section-divider"><i class="fas fa-scroll"></i> Ø¯Ø±Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© / Ø§Ù„Ø£Ø·Ø±ÙˆØ­Ø©</div>
    <div class="field" style="margin-top:10px;">
      <input type="number" id="editThesisGrade" min="0" max="100"
        placeholder="Ø£Ø¯Ø®Ù„ Ø¯Ø±Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© (0-100) Ø£Ùˆ Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹" />
    </div>

    <input type="hidden" id="editRecordIndex" />
    <div class="btn-group" style="margin-top:18px;">
      <button class="btn btn-primary" style="flex:2;" onclick="saveEditedRecord()">
        <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨
      </button>
      <button class="btn btn-outline" style="flex:1;" onclick="closeEditModal(null)">
        <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
      </button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
  // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let course1Data = [], course2Data = [];
  let course1Avg = 0, course2Avg = 0, finalAvg = 0;
  let currentStep = 1;

  // â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let toastTimer;
  function showToast(msg, type = 'info') {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'show ' + type;
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => t.className = '', 3000);
  }

  // â”€â”€ Steps â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setStep(n) {
    currentStep = n;
    for (let i = 1; i <= 5; i++) {
      const el = document.getElementById('step-' + i);
      el.classList.remove('active', 'done');
      if (i < n) el.classList.add('done');
      else if (i === n) el.classList.add('active');
    }
  }

  function show(id) { document.getElementById(id).classList.remove('hidden'); }
  function hide(id) { document.getElementById(id).classList.add('hidden'); }

  // â”€â”€ STEP 1 â†’ 2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function goToCourse1() {
    const dept  = document.getElementById('department').value;
    const name  = document.getElementById('studentName').value.trim();
    const stage = document.getElementById('stage').value;
    if (!dept)  { showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¹Ù„Ù…ÙŠ', 'error'); return; }
    if (!name)  { showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨', 'error'); return; }
    if (!stage) { showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©', 'error'); return; }
    setStep(2);
    show('cardCourse1');
    document.getElementById('cardCourse1').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  // â”€â”€ Generate Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function generateCourseTable(n) {
    const countId = n === 1 ? 'course1Count' : 'course2Count';
    const divId   = n === 1 ? 'course1TableDiv' : 'course2TableDiv';
    const calcId  = n === 1 ? 'calculateCourse1Div' : 'calculateCourse2Div';
    const count   = parseInt(document.getElementById(countId).value);

    if (isNaN(count) || count < 1 || count > 20) {
      showToast('Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯Ø§Ù‹ ØµØ­ÙŠØ­Ø§Ù‹ Ø¨ÙŠÙ† 1 Ùˆ 20', 'error'); return;
    }

    let html = `<div style="overflow-x:auto; border-radius:10px; border:1px solid var(--border); margin-top:12px;">
      <table class="subjects-table">
        <thead><tr>
          <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø© (0-100)</th><th>Ø§Ù„ÙˆØ²Ù† (Ø³Ø§Ø¹Ø§Øª)</th>
        </tr></thead><tbody>`;
    for (let i = 0; i < count; i++) {
      html += `<tr>
        <td><input type="text" class="subject-name" data-course="${n}" data-index="${i}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©" /></td>
        <td><input type="number" min="0" max="100" class="subject-grade" data-course="${n}" data-index="${i}" placeholder="0-100" /></td>
        <td><input type="number" min="1" class="subject-weight" data-course="${n}" data-index="${i}" placeholder="3" /></td>
      </tr>`;
    }
    html += `</tbody></table></div>`;

    document.getElementById(divId).innerHTML = html;
    show(calcId);
  }

  // â”€â”€ Calculate Course 1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function calculateCourse1() {
    course1Data = [];
    const names   = document.querySelectorAll('.subject-name[data-course="1"]');
    const grades  = document.querySelectorAll('.subject-grade[data-course="1"]');
    const weights = document.querySelectorAll('.subject-weight[data-course="1"]');

    for (let i = 0; i < names.length; i++) {
      const name   = names[i].value.trim();
      const grade  = parseFloat(grades[i].value);
      const weight = parseFloat(weights[i].value);
      if (!name || isNaN(grade) || grade < 0 || grade > 100 || isNaN(weight) || weight < 1) {
        showToast(`ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ø¯Ø© Ø±Ù‚Ù… ${i+1} Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­`, 'error'); return;
      }
      course1Data.push({ name, grade, weight });
    }

    const totalW = course1Data.reduce((a, c) => a + c.weight, 0);
    const sumGW  = course1Data.reduce((a, c) => a + c.grade * c.weight, 0);
    course1Avg   = sumGW / totalW;

    document.getElementById('course1AvgVal').textContent = course1Avg.toFixed(2);
    show('course1AvgDiv');
    hide('calculateCourse1Div');
    setStep(3);
    show('cardAskCourse2');
    showToast('ØªÙ… Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙƒÙˆØ±Ø³ Ø§Ù„Ø£ÙˆÙ„ âœ“', 'success');
    document.getElementById('cardAskCourse2').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  // â”€â”€ Course 2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showCourse2Input(yes) {
    hide('cardAskCourse2');
    if (yes) {
      show('cardCourse2');
      document.getElementById('cardCourse2').scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
      course2Data = []; course2Avg = 0;
      showThesisCard();
    }
  }

  function calculateCourse2() {
    course2Data = [];
    const names   = document.querySelectorAll('.subject-name[data-course="2"]');
    const grades  = document.querySelectorAll('.subject-grade[data-course="2"]');
    const weights = document.querySelectorAll('.subject-weight[data-course="2"]');

    for (let i = 0; i < names.length; i++) {
      const name   = names[i].value.trim();
      const grade  = parseFloat(grades[i].value);
      const weight = parseFloat(weights[i].value);
      if (!name || isNaN(grade) || grade < 0 || grade > 100 || isNaN(weight) || weight < 1) {
        showToast(`ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ø¯Ø© Ø±Ù‚Ù… ${i+1} Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­`, 'error'); return;
      }
      course2Data.push({ name, grade, weight });
    }

    const totalW = course2Data.reduce((a, c) => a + c.weight, 0);
    const sumGW  = course2Data.reduce((a, c) => a + c.grade * c.weight, 0);
    course2Avg   = sumGW / totalW;

    document.getElementById('course2AvgVal').textContent = course2Avg.toFixed(2);
    show('course2AvgDiv');
    hide('calculateCourse2Div');
    showToast('ØªÙ… Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙƒÙˆØ±Ø³ Ø§Ù„Ø«Ø§Ù†ÙŠ âœ“', 'success');
    showThesisCard();
  }

  function showThesisCard() {
    setStep(4);
    show('cardAskThesis');
    document.getElementById('cardAskThesis').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  // â”€â”€ Thesis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showThesisInput(yes) {
    hide('cardAskThesis');
    if (yes) {
      show('cardThesis');
      document.getElementById('cardThesis').scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
      calculateFinalAvg(false);
    }
  }

  // â”€â”€ Final Average â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function calculateFinalAvg(thesisExists = true) {
    const stage = document.getElementById('stage').value;
    let thesisGrade = 0;

    if (thesisExists) {
      thesisGrade = parseFloat(document.getElementById('thesisGrade').value);
      if (isNaN(thesisGrade) || thesisGrade < 0 || thesisGrade > 100) {
        showToast('Ø£Ø¯Ø®Ù„ Ø¯Ø±Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨ÙŠÙ† 0 Ùˆ 100', 'error'); return;
      }
    }

    // Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª â€” Ù…ØªÙˆØ³Ø· Ø­Ø³Ø§Ø¨ÙŠ Ø¨Ø³ÙŠØ· Ø¯Ø§Ø¦Ù…Ø§Ù‹
    let coursesAvg = 0;
    if (course1Data.length > 0 && course2Data.length > 0) coursesAvg = (course1Avg + course2Avg) / 2;
    else if (course1Data.length > 0) coursesAvg = course1Avg;
    else if (course2Data.length > 0) coursesAvg = course2Avg;

    // Formula by stage â€” ØªÙØ·Ø¨Ù‚ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø© Ø§Ù„Ù…ÙˆØ²ÙˆÙ†Ø© ÙÙ‚Ø· Ø¥Ø°Ø§ ÙˆÙØ¬Ø¯Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    let formula = '';
    if (stage === 'phd') {
      if (thesisExists) {
        // Ø§Ù„Ø¯ÙƒØªÙˆØ±Ø§Ù‡ Ù…Ø¹ Ø£Ø·Ø±ÙˆØ­Ø©: Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª 33.34% + Ø§Ù„Ø£Ø·Ø±ÙˆØ­Ø© 66.66%
        finalAvg = (coursesAvg * 0.3334) + (thesisGrade * 0.6666);
        formula  = `(Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª ${coursesAvg.toFixed(2)} Ã— 33.34%) + (Ø¯Ø±Ø¬Ø© Ø§Ù„Ø£Ø·Ø±ÙˆØ­Ø© ${thesisGrade} Ã— 66.66%)`;
      } else {
        // Ø¨Ø¯ÙˆÙ† Ø£Ø·Ø±ÙˆØ­Ø©: Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠ Ù„Ù„ÙƒÙˆØ±Ø³Ø§Øª ÙÙ‚Ø·
        finalAvg = coursesAvg;
        formula  = `Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø£Ø·Ø±ÙˆØ­Ø©) = ${coursesAvg.toFixed(2)}`;
      }
    } else {
      if (thesisExists) {
        // Ù…Ø§Ø¬Ø³ØªÙŠØ± / Ø¯Ø¨Ù„ÙˆÙ… Ù…Ø¹ Ø±Ø³Ø§Ù„Ø©: Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª 66.66% + Ø§Ù„Ø±Ø³Ø§Ù„Ø© 33.34%
        finalAvg = (coursesAvg * 0.6666) + (thesisGrade * 0.3334);
        formula  = `(Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª ${coursesAvg.toFixed(2)} Ã— 66.66%) + (Ø¯Ø±Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© ${thesisGrade} Ã— 33.34%)`;
      } else {
        // Ø¨Ø¯ÙˆÙ† Ø±Ø³Ø§Ù„Ø©: Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠ Ù„Ù„ÙƒÙˆØ±Ø³Ø§Øª ÙÙ‚Ø·
        finalAvg = coursesAvg;
        formula  = `Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø±Ø³Ø§Ù„Ø©) = ${coursesAvg.toFixed(2)}`;
      }
    }

    // Show result
    const stageLabel = stage === 'phd' ? 'Ø§Ù„Ø¯ÙƒØªÙˆØ±Ø§Ù‡' : stage === 'master' ? 'Ø§Ù„Ù…Ø§Ø¬Ø³ØªÙŠØ±' : 'Ø§Ù„Ø¯Ø¨Ù„ÙˆÙ…';
    document.getElementById('finalResultBox').innerHTML = `
      <div class="result-box final">
        <div class="result-icon">ğŸ†</div>
        <div>
          <div class="result-label">Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ â€” ${stageLabel}</div>
          <div class="result-value">${finalAvg.toFixed(2)}</div>
          <div class="result-sub">${document.getElementById('studentName').value.trim()}</div>
        </div>
      </div>`;
    document.getElementById('formulaBox').innerHTML = `
      <div style="background:var(--surface2); border:1px solid var(--border); border-radius:10px; padding:12px 16px; font-size:13px; color:var(--text-dim);">
        <strong style="color:var(--accent);">Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©:</strong><br>
        <span style="direction:rtl; display:inline-block; margin-top:4px;">${formula}</span>
      </div>`;

    setStep(5);
    hide('cardThesis');
    show('cardResult');
    showToast('ØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ âœ“', 'success');
    document.getElementById('cardResult').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  // â”€â”€ Save â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function saveResult() {
    const studentName = document.getElementById('studentName').value.trim();
    const department  = document.getElementById('department').value;
    const stage       = document.getElementById('stage').value;
    if (!studentName || !department || !stage || finalAvg === 0) {
      showToast('ÙŠØ±Ø¬Ù‰ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø£ÙˆÙ„Ø§Ù‹', 'error'); return;
    }
    const thesisGradeVal = parseFloat(document.getElementById('thesisGrade').value);
    const thesisGradeSaved = isNaN(thesisGradeVal) ? null : thesisGradeVal;
    const coursesAvgSaved = (course1Data.length > 0 && course2Data.length > 0)
      ? (course1Avg + course2Avg) / 2
      : (course1Data.length > 0 ? course1Avg : course2Avg);    const record = {
      studentName, department, stage,
      course1Avg, course2HasData: course2Data.length > 0, course2Avg,
      coursesAvg: coursesAvgSaved, thesisGrade: thesisGradeSaved, finalAvg,
      course1Subjects: course1Data.map(s => ({ name: s.name, grade: s.grade, weight: s.weight })),
      course2Subjects: course2Data.map(s => ({ name: s.name, grade: s.grade, weight: s.weight })),
      timestamp: new Date().toISOString()
    };
    const list = JSON.parse(localStorage.getItem('studentRecords') || '[]');
    list.push(record);
    localStorage.setItem('studentRecords', JSON.stringify(list));
    showToast('âœ“ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
    loadSavedRecords();
    // Show next student prompt
    show('cardNextStudent');
    document.getElementById('cardNextStudent').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  // â”€â”€ Next Student (keep subjects & weights, clear grades & name) â”€â”€
  function nextStudent() {
    hide('cardNextStudent');

    // Snapshot BEFORE resetting â€” names and weights only
    const c1Names   = [...document.querySelectorAll('.subject-name[data-course="1"]')].map(el => el.value);
    const c1Weights = [...document.querySelectorAll('.subject-weight[data-course="1"]')].map(el => el.value);
    const c2Names   = [...document.querySelectorAll('.subject-name[data-course="2"]')].map(el => el.value);
    const c2Weights = [...document.querySelectorAll('.subject-weight[data-course="2"]')].map(el => el.value);
    const hadCourse2 = c2Names.length > 0 && c2Names.some(n => n.trim() !== '');

    // Reset all state
    course1Data = []; course2Data = [];
    course1Avg  = 0;  course2Avg = 0; finalAvg = 0;

    // Clear name and thesis only (keep dept & stage)
    document.getElementById('studentName').value = '';
    document.getElementById('thesisGrade').value = '';

    // Hide all step cards fully
    ['cardResult', 'cardAskCourse2', 'cardCourse2', 'cardAskThesis', 'cardThesis',
     'calculateCourse1Div', 'course1AvgDiv', 'calculateCourse2Div', 'course2AvgDiv'].forEach(hide);

    // Clear result displays
    document.getElementById('finalResultBox').innerHTML = '';
    document.getElementById('formulaBox').innerHTML = '';

    // Rebuild course 1 table â€” names & weights intact, grades empty
    if (c1Names.length > 0) {
      let html = `<div style="overflow-x:auto; border-radius:10px; border:1px solid var(--border); margin-top:12px;">
        <table class="subjects-table">
          <thead><tr>
            <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø© (0-100)</th><th>Ø§Ù„ÙˆØ²Ù† (Ø³Ø§Ø¹Ø§Øª)</th>
          </tr></thead><tbody>`;
      c1Names.forEach((name, i) => {
        html += `<tr>
          <td><input type="text" class="subject-name" data-course="1" data-index="${i}" value="${name}" /></td>
          <td><input type="number" min="0" max="100" class="subject-grade" data-course="1" data-index="${i}" placeholder="0-100" /></td>
          <td><input type="number" min="1" class="subject-weight" data-course="1" data-index="${i}" value="${c1Weights[i]}" /></td>
        </tr>`;
      });
      html += `</tbody></table></div>`;
      document.getElementById('course1TableDiv').innerHTML = html;
      document.getElementById('course1Count').value = c1Names.length;
      show('calculateCourse1Div');
    }

    // Rebuild course 2 table if it existed â€” grades empty
    if (hadCourse2) {
      let html2 = `<div style="overflow-x:auto; border-radius:10px; border:1px solid var(--border); margin-top:12px;">
        <table class="subjects-table">
          <thead><tr>
            <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø© (0-100)</th><th>Ø§Ù„ÙˆØ²Ù† (Ø³Ø§Ø¹Ø§Øª)</th>
          </tr></thead><tbody>`;
      c2Names.forEach((name, i) => {
        html2 += `<tr>
          <td><input type="text" class="subject-name" data-course="2" data-index="${i}" value="${name}" /></td>
          <td><input type="number" min="0" max="100" class="subject-grade" data-course="2" data-index="${i}" placeholder="0-100" /></td>
          <td><input type="number" min="1" class="subject-weight" data-course="2" data-index="${i}" value="${c2Weights[i]}" /></td>
        </tr>`;
      });
      html2 += `</tbody></table></div>`;
      document.getElementById('course2TableDiv').innerHTML = html2;
      document.getElementById('course2Count').value = c2Names.length;
      // Pre-show course2 card and calc button so flow continues automatically
      show('cardCourse2');
      show('calculateCourse2Div');
    } else {
      document.getElementById('course2TableDiv').innerHTML = '';
    }

    setStep(2);
    show('cardCourse1');
    showToast('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆØ¯Ø±Ø¬Ø§ØªÙ‡ âœï¸', 'info');
    document.getElementById('studentName').focus();
    document.getElementById('cardInfo').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  // â”€â”€ Reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function resetAll() {
    course1Data = []; course2Data = [];
    course1Avg = 0; course2Avg = 0; finalAvg = 0;
    ['department','studentName','stage','course1Count','course2Count','thesisGrade'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = '';
    });
    ['course1TableDiv','course2TableDiv'].forEach(id => document.getElementById(id).innerHTML = '');
    ['cardCourse1','cardAskCourse2','cardCourse2','cardAskThesis','cardThesis','cardResult','cardNextStudent',
     'calculateCourse1Div','course1AvgDiv','calculateCourse2Div','course2AvgDiv'].forEach(hide);
    setStep(1);
    showToast('ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†', 'info');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // â”€â”€ Load Records â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function loadSavedRecords() {
    const list = JSON.parse(localStorage.getItem('studentRecords') || '[]');
    const wrap = document.getElementById('recordsWrap');
    if (list.length === 0) {
      wrap.innerHTML = '<div class="records-empty"><i class="fas fa-inbox" style="font-size:28px; display:block; margin-bottom:8px;"></i>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©</div>';
      return;
    }
    const badgeClass = s => s === 'phd' ? 'badge-phd' : s === 'master' ? 'badge-master' : 'badge-diploma';
    const stageLabel = s => s === 'phd' ? 'Ø¯ÙƒØªÙˆØ±Ø§Ù‡' : s === 'master' ? 'Ù…Ø§Ø¬Ø³ØªÙŠØ±' : 'Ø¯Ø¨Ù„ÙˆÙ…';
    wrap.innerHTML = `<div class="table-wrap"><table class="records-table">
      <thead><tr>
        <th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th>
        <th>Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª</th><th>Ø¯Ø±Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©</th><th>Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th></th>
      </tr></thead><tbody>
      ${list.map((r, i) => `<tr>
        <td style="font-size:12px; text-align:right;">${r.department}</td>
        <td style="text-align:right; font-weight:600;">${r.studentName}</td>
        <td><span class="badge ${badgeClass(r.stage)}">${stageLabel(r.stage)}</span></td>
        <td>${r.coursesAvg != null ? r.coursesAvg.toFixed(2) : r.course1Avg.toFixed(2)}</td>
        <td>${r.thesisGrade != null ? r.thesisGrade.toFixed(2) : 'â€”'}</td>
        <td><strong style="color:var(--accent); font-size:15px;">${r.finalAvg.toFixed(2)}</strong></td>
        <td style="font-size:11px; color:var(--text-dim);">${new Date(r.timestamp).toLocaleDateString('ar')}</td>
        <td style="white-space:nowrap;">
          <button title="ØªØ¹Ø¯ÙŠÙ„" style="background:none;border:none;font-size:20px;cursor:pointer;padding:2px 5px;" onclick="openEditModal(${i})">âœï¸</button>
          <button title="Ø­Ø°Ù"   style="background:none;border:none;font-size:20px;cursor:pointer;padding:2px 5px;" onclick="deleteRecord(${i})">ğŸ—‘ï¸</button>
        </td>
      </tr>`).join('')}
      </tbody></table></div>`;
  }

  function deleteRecord(index) {
    if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ')) return;
    const list = JSON.parse(localStorage.getItem('studentRecords') || '[]');
    list.splice(index, 1);
    localStorage.setItem('studentRecords', JSON.stringify(list));
    loadSavedRecords();
    showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„', 'info');
  }

  function confirmDeleteAll() {
    if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§ØªØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.')) return;
    localStorage.removeItem('studentRecords');
    loadSavedRecords();
    showToast('ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª', 'info');
  }

  // â”€â”€ Download Word (current) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function downloadDOCX() {
    const { Document, Packer, Paragraph, TextRun } = window.docx;
    if (finalAvg === 0) { showToast('Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø£ÙˆÙ„Ø§Ù‹', 'error'); return; }
    const name  = document.getElementById('studentName').value.trim();
    const dept  = document.getElementById('department').value;
    const stage = document.getElementById('stage').value;
    const stageLabel = stage === 'phd' ? 'Ø§Ù„Ø¯ÙƒØªÙˆØ±Ø§Ù‡' : stage === 'master' ? 'Ø§Ù„Ù…Ø§Ø¬Ø³ØªÙŠØ±' : 'Ø§Ù„Ø¯Ø¨Ù„ÙˆÙ…';

    const doc = new Document({ sections: [{ properties: {}, children: [
      new Paragraph({ children: [new TextRun({ text: 'Ù†ØªÙŠØ¬Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù„', bold: true, size: 36, font: 'Arial' })], alignment: 'center' }),
      new Paragraph({ text: '' }),
      new Paragraph({ children: [new TextRun({ text: `Ø§Ù„Ø§Ø³Ù…: ${name}`, size: 28, font: 'Arial' })], alignment: 'right' }),
      new Paragraph({ children: [new TextRun({ text: `Ø§Ù„Ù‚Ø³Ù…: ${dept}`, size: 28, font: 'Arial' })], alignment: 'right' }),
      new Paragraph({ children: [new TextRun({ text: `Ø§Ù„Ù…Ø±Ø­Ù„Ø©: ${stageLabel}`, size: 28, font: 'Arial' })], alignment: 'right' }),
      new Paragraph({ text: '' }),
      new Paragraph({ children: [new TextRun({ text: `Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙƒÙˆØ±Ø³ Ø§Ù„Ø£ÙˆÙ„: ${course1Avg.toFixed(2)}`, size: 28, font: 'Arial' })], alignment: 'right' }),
      new Paragraph({ children: [new TextRun({ text: `Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙƒÙˆØ±Ø³ Ø§Ù„Ø«Ø§Ù†ÙŠ: ${course2Data.length > 0 ? course2Avg.toFixed(2) : 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'}`, size: 28, font: 'Arial' })], alignment: 'right' }),
      new Paragraph({ text: '' }),
      new Paragraph({ children: [new TextRun({ text: `Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ${finalAvg.toFixed(2)}`, bold: true, size: 32, font: 'Arial' })], alignment: 'right' }),
    ]}]});

    const blob = await Packer.toBlob(doc);
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${name}_result.docx`;
    a.click();
    URL.revokeObjectURL(a.href);
    showToast('âœ“ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Word', 'success');
  }

  // â”€â”€ Download Records Word â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function downloadRecordsDOCX() {
    const { Document, Packer, Paragraph, TextRun, Table, TableRow, TableCell,
            BorderStyle, AlignmentType, WidthType, ShadingType } = window.docx;
    const list = JSON.parse(localStorage.getItem('studentRecords') || '[]');
    if (list.length === 0) { showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§', 'error'); return; }

    const stageLabel = s => s === 'phd' ? 'Ø¯ÙƒØªÙˆØ±Ø§Ù‡' : s === 'master' ? 'Ù…Ø§Ø¬Ø³ØªÙŠØ±' : 'Ø¯Ø¨Ù„ÙˆÙ…';

    const borders = {
      top:    { style: BorderStyle.SINGLE, size: 4, color: '5b52e8' },
      bottom: { style: BorderStyle.SINGLE, size: 4, color: '5b52e8' },
      left:   { style: BorderStyle.SINGLE, size: 4, color: '5b52e8' },
      right:  { style: BorderStyle.SINGLE, size: 4, color: '5b52e8' },
    };

    // Header cell â€” Ø¨Ù†ÙØ³Ø¬ÙŠ Ø¯Ø§ÙƒÙ† + Ù†Øµ Ø£Ø¨ÙŠØ¶ Ø¹Ø±ÙŠØ¶
    const hCell = text => new TableCell({
      borders,
      shading: { type: ShadingType.SOLID, color: '5b52e8' },
      children: [new Paragraph({
        alignment: AlignmentType.CENTER,
        children: [new TextRun({ text, bold: true, color: 'FFFFFF', size: 28, font: 'Arial' })]
      })]
    });

    // Data cell â€” Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡ / Ø±Ù…Ø§Ø¯ÙŠØ© ÙØ§ØªØ­Ø© Ø¨Ø§Ù„ØªÙ†Ø§ÙˆØ¨
    const dCell = (text, shade = false) => new TableCell({
      borders,
      shading: shade ? { type: ShadingType.SOLID, color: 'F4F5FF' } : undefined,
      children: [new Paragraph({
        alignment: AlignmentType.CENTER,
        children: [new TextRun({ text: String(text), size: 28, font: 'Arial' })]
      })]
    });

    // Final avg cell â€” Ø¨Ù†ÙØ³Ø¬ÙŠ ÙØ§ØªØ­ + Ù†Øµ Ø¹Ø±ÙŠØ¶
    const fCell = (text, shade = false) => new TableCell({
      borders,
      shading: { type: ShadingType.SOLID, color: shade ? 'EDE9FF' : 'E0E7FF' },
      children: [new Paragraph({
        alignment: AlignmentType.CENTER,
        children: [new TextRun({ text: String(text), bold: true, size: 28, font: 'Arial', color: '5b52e8' })]
      })]
    });

    // Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ø¥Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø±
    const headers = ['Ø§Ù„Ù‚Ø³Ù…', 'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨', 'Ø§Ù„Ù…Ø±Ø­Ù„Ø©', 'Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª', 'Ø¯Ø±Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©', 'Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ', 'Ø§Ù„ØªØ§Ø±ÙŠØ®'];

    const doc = new Document({
      sections: [{
        properties: {},
        children: [
          new Paragraph({
            alignment: AlignmentType.CENTER,
            spacing: { after: 100 },
            children: [new TextRun({ text: 'Ø³Ø¬Ù„Ø§Øª Ø·Ù„Ø§Ø¨ Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø¹Ù„ÙŠØ§', bold: true, size: 36, font: 'Arial', color: '5b52e8' })]
          }),
          new Paragraph({
            alignment: AlignmentType.CENTER,
            spacing: { after: 300 },
            children: [new TextRun({ text: `ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµØ¯ÙŠØ±: ${new Date().toLocaleDateString('ar-IQ')}   |   Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${list.length}`, size: 28, font: 'Arial', color: '6b7280' })]
          }),
          new Table({
            width: { size: 100, type: WidthType.PERCENTAGE },
            bidi: true,
            rows: [
              // Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„ â€” Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ†: Ø§Ù„Ù‚Ø³Ù…ØŒ Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù…Ø±Ø­Ù„Ø©ØŒ Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙƒÙˆØ±Ø³Ø§ØªØŒ Ø¯Ø±Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŒ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØŒ Ø§Ù„ØªØ§Ø±ÙŠØ®
              new TableRow({
                tableHeader: true,
                children: [...headers].reverse().map(h => hCell(h))
              }),
              // ØµÙÙˆÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ ØªÙ„ÙˆÙŠÙ† Ù…ØªÙ†Ø§ÙˆØ¨ â€” Ù†ÙØ³ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø±Ø£Ø³ Ù…Ø¹ÙƒÙˆØ³Ø§Ù‹
              ...list.map((r, i) => {
                const shade = i % 2 === 1;
                const coursesAvgDisplay = r.coursesAvg != null
                  ? r.coursesAvg.toFixed(2)
                  : r.course1Avg.toFixed(2);
                const cells = [
                  dCell(r.department, shade),
                  dCell(r.studentName, shade),
                  dCell(stageLabel(r.stage), shade),
                  dCell(coursesAvgDisplay, shade),
                  dCell(r.thesisGrade != null ? r.thesisGrade.toFixed(2) : 'â€”', shade),
                  fCell(r.finalAvg.toFixed(2), shade),
                  dCell(new Date(r.timestamp).toLocaleDateString('ar-IQ'), shade),
                ];
                return new TableRow({ children: [...cells].reverse() });
              })
            ]
          }),
          new Paragraph({
            spacing: { before: 300 },
            alignment: AlignmentType.CENTER,
            children: [new TextRun({ text: 'Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù†Ø´Ø± Â© Ø¯. Ø·Ù„Ø§Ù„ Ù†Ø§Ø¸Ù… Ø§Ù„Ø²Ù‡ÙŠØ±ÙŠ Ùˆ Ø¯. Ø¹Ù„ÙŠ Ø¹Ø¨Ø¯ Ø§Ù„ØµÙ…Ø¯ â€” 2025', size: 16, font: 'Arial', color: '9ca3af' })]
          })
        ]
      }]
    });

    const blob = await Packer.toBlob(doc);
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `students_records_${new Date().toISOString().split('T')[0]}.docx`;
    a.click();
    URL.revokeObjectURL(a.href);
    showToast('âœ“ ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø³Ø¬Ù„Ø§Øª', 'success');
  }

  // â”€â”€ Edit Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function openEditModal(index) {
    const list = JSON.parse(localStorage.getItem('studentRecords') || '[]');
    const r = list[index];
    if (!r) return;

    document.getElementById('editRecordIndex').value = index;

    // Info chips
    const stageLabel = r.stage === 'phd' ? 'Ø¯ÙƒØªÙˆØ±Ø§Ù‡' : r.stage === 'master' ? 'Ù…Ø§Ø¬Ø³ØªÙŠØ±' : 'Ø¯Ø¨Ù„ÙˆÙ…';
    document.getElementById('modalInfoRow').innerHTML = `
      <span class="modal-chip">ğŸ‘¤ ${r.studentName}</span>
      <span class="modal-chip">ğŸ› ${r.department}</span>
      <span class="modal-chip">ğŸ“ ${stageLabel}</span>`;

    // Course 1
    const c1Body = document.getElementById('editCourse1Body');
    c1Body.innerHTML = '';
    if (r.course1Subjects && r.course1Subjects.length > 0) {
      r.course1Subjects.forEach((s, i) => {
        c1Body.innerHTML += `<tr>
          <td>${s.name}</td>
          <td><input type="number" min="0" max="100" class="edit-c1-grade" data-index="${i}" data-weight="${s.weight}" value="${s.grade}" /></td>
        </tr>`;
      });
    } else {
      c1Body.innerHTML = `<tr><td colspan="2" style="text-align:center; color:var(--text-dim); padding:12px; font-size:12px;">Ù„Ø§ ØªØªÙˆÙØ± ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ â€” ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø±Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙ‚Ø·</td></tr>`;
    }

    // Course 2
    const c2Section = document.getElementById('editCourse2Section');
    const c2Body = document.getElementById('editCourse2Body');
    c2Body.innerHTML = '';
    if (r.course2Subjects && r.course2Subjects.length > 0) {
      c2Section.classList.remove('hidden');
      r.course2Subjects.forEach((s, i) => {
        c2Body.innerHTML += `<tr>
          <td>${s.name}</td>
          <td><input type="number" min="0" max="100" class="edit-c2-grade" data-index="${i}" data-weight="${s.weight}" value="${s.grade}" /></td>
        </tr>`;
      });
    } else {
      c2Section.classList.add('hidden');
    }

    // Thesis
    document.getElementById('editThesisGrade').value = r.thesisGrade != null ? r.thesisGrade : '';

    document.getElementById('editModalOverlay').classList.add('open');
  }

  function closeEditModal(event) {
    if (event && event.target !== document.getElementById('editModalOverlay')) return;
    document.getElementById('editModalOverlay').classList.remove('open');
  }

  function saveEditedRecord() {
    const index = parseInt(document.getElementById('editRecordIndex').value);
    const list  = JSON.parse(localStorage.getItem('studentRecords') || '[]');
    const r     = list[index];
    if (!r) return;

    // Recalculate course 1 avg if subjects available
    const c1Inputs = document.querySelectorAll('.edit-c1-grade');
    if (c1Inputs.length > 0) {
      let totalW = 0, sumGW = 0, valid = true;
      c1Inputs.forEach(inp => {
        const grade  = parseFloat(inp.value);
        const weight = parseFloat(inp.dataset.weight);
        if (isNaN(grade) || grade < 0 || grade > 100) { valid = false; return; }
        totalW += weight; sumGW += grade * weight;
        // Update subject grade in record
        const i = parseInt(inp.dataset.index);
        if (r.course1Subjects && r.course1Subjects[i]) r.course1Subjects[i].grade = grade;
      });
      if (!valid) { showToast('ØªØ­Ù‚Ù‚ Ù…Ù† Ø¯Ø±Ø¬Ø§Øª Ø§Ù„ÙƒÙˆØ±Ø³ Ø§Ù„Ø£ÙˆÙ„ (0-100)', 'error'); return; }
      if (totalW > 0) r.course1Avg = sumGW / totalW;
    }

    // Recalculate course 2 avg if subjects available
    const c2Inputs = document.querySelectorAll('.edit-c2-grade');
    if (c2Inputs.length > 0) {
      let totalW = 0, sumGW = 0, valid = true;
      c2Inputs.forEach(inp => {
        const grade  = parseFloat(inp.value);
        const weight = parseFloat(inp.dataset.weight);
        if (isNaN(grade) || grade < 0 || grade > 100) { valid = false; return; }
        totalW += weight; sumGW += grade * weight;
        const i = parseInt(inp.dataset.index);
        if (r.course2Subjects && r.course2Subjects[i]) r.course2Subjects[i].grade = grade;
      });
      if (!valid) { showToast('ØªØ­Ù‚Ù‚ Ù…Ù† Ø¯Ø±Ø¬Ø§Øª Ø§Ù„ÙƒÙˆØ±Ø³ Ø§Ù„Ø«Ø§Ù†ÙŠ (0-100)', 'error'); return; }
      if (totalW > 0) r.course2Avg = sumGW / totalW;
    }

    // Update thesis grade
    const thesisVal = document.getElementById('editThesisGrade').value;
    const thesisGrade = thesisVal === '' ? null : parseFloat(thesisVal);
    if (thesisGrade !== null && (isNaN(thesisGrade) || thesisGrade < 0 || thesisGrade > 100)) {
      showToast('Ø¯Ø±Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¨ÙŠÙ† 0 Ùˆ 100', 'error'); return;
    }
    r.thesisGrade = thesisGrade;

    // Recalculate coursesAvg â€” Ù…ØªÙˆØ³Ø· Ø­Ø³Ø§Ø¨ÙŠ Ø¨Ø³ÙŠØ· Ø¯Ø§Ø¦Ù…Ø§Ù‹
    const hasC2 = r.course2Subjects && r.course2Subjects.length > 0;
    r.coursesAvg = hasC2 ? (r.course1Avg + r.course2Avg) / 2 : r.course1Avg;

    // Recalculate finalAvg â€” Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø© Ø§Ù„Ù…ÙˆØ²ÙˆÙ†Ø© ÙÙ‚Ø· Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    if (r.stage === 'phd') {
      r.finalAvg = thesisGrade != null
        ? (r.coursesAvg * 0.3334) + (thesisGrade * 0.6666)
        : r.coursesAvg;
    } else {
      r.finalAvg = thesisGrade != null
        ? (r.coursesAvg * 0.6666) + (thesisGrade * 0.3334)
        : r.coursesAvg;
    }

    list[index] = r;
    localStorage.setItem('studentRecords', JSON.stringify(list));
    loadSavedRecords();
    document.getElementById('editModalOverlay').classList.remove('open');
    showToast('âœ“ ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨', 'success');
  }

  // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.addEventListener('DOMContentLoaded', loadSavedRecords);
</script>
</body>
</html>
